{% extends "base.html" %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

<!-- Кнопка для открытия фильтров -->
<!-- Фоновая панель для модального окна -->
<div id="modalBackdrop" class="modal-backdrop relative">
  <!-- Блок с фильтрами (изначально скрыт) -->
  <div id="filters" class="modal">
    <!-- Форма фильтрации -->
    <form method="get" id="filterForm" class="max-w-4xl m-auto">
      <div class='mb-2 flex flex-col gap-4'>
        {{ filter_form.as_p }}
      </div>
      <button class="btn btn-secondary"  type="submit">Применить фильтр</button>
      <button class="btn btn-success" type="button" id="saveFilter">Сохранить фильтр</button>
      <button class="close btn btn-danger absolute top-2 right-1 rounded-full " id="closeFilters" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </form>

    <!-- Кнопка для закрытия фильтров -->


    <!-- Список сохраненных фильтров -->
    <div id="savedFilters" class="m-auto max-w-4xl ">
      <h3 class="text-2xl  p-10 text-center" >Сохраненные фильтры:</h3>
      <ul>
        {% for saved_filter in saved_filters %}
          <li>
            <a href="?load_filter={{ saved_filter.id }}">{{ saved_filter.filter_name }}</a>
            <a href="?delete_filter={{ saved_filter.id }}" class="deleteFilter">Удалить</a>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<div class="requests-list">
    <h3 class="text-center text-4xl p-10 max-w-4xl m-auto">Список заявок</h3>
    {% if not requests_with_action %}
      <p class="text-center text-xl p-4 max-w-4xl m-auto">Нет доступных заявок</p>
    {% else %}
      <form id="delete-form" method="post" action="{% url 'request_delete' %}">
        {% csrf_token %}
        <table id="requestsTable" class="table">
          <thead>
            <tr>
              <th class="text-center"><input type="checkbox" id="select-all"></th>
              <th class="text-center">Название заявки</th>
              <th class="text-center">Тип</th>
              <th class="text-center">Приоритет</th>
              <th class="text-center">Исполнитель</th>
              <th class="text-center">Заявитель</th>
              <th class="text-center">Статус</th>
              <th class="text-center">Срок выполнения</th>
              <th class="text-center">Время обновления</th>
              <th class="text-center">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for item in requests_with_action %}
            <tr class="align-middle">
                <td class="text-center"><input type="checkbox" name="selected_requests" value="{{ item.request.pk }}"></td>
                <td class="text-center">{{ item.request.title }}</td>
                <td class="text-center">{{ item.request.request_type }}</td>
                <td class="text-center">{{ item.request.priority }}</td>
                <td class="text-center">{{ item.request.assignee }}</td>
                <td class="text-center">{{ item.request.requester }}</td>
                <td class="text-center">{{ item.request.status }}</td>
                <td class="text-center">{% if item.request.due_date %}{{ item.request.due_date|date:"d.m.Y" }}{% else %}Не указано{% endif %}</td>
                <td class="text-center">{% if item.request.updated_at %}{{ item.request.updated_at|date:"d.m.Y H:i" }}{% else %}Не указано{% endif %}</td>
                <!-- Кнопка удаления теперь в своей ячейке -->
                <td class="flex gap-2 justify-evenly">
                    <button onclick="window.location.href='{% url 'request_edit' item.request.pk %}'" type="button" class="btn btn-primary">Редактировать</button>
                </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        <button type="submit" class="btn btn-danger mb-3">Удалить выбранные заявки</button>
      </form>
    {% endif %}
    <button onclick="window.location.href='{% url 'select_request_type' %}'" class="btn btn-success" type="button">Создать новую заявку</button>
    <button class="btn btn-primary" id="openFilters">Открыть фильтры</button>
    <button class="btn btn-secondary" id="exportPdf">Экспорт в PDF</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const openFiltersButton = document.getElementById('openFilters');
    const closeFiltersButton = document.getElementById('closeFilters');
    const filtersDiv = document.getElementById('filters');
    const modalBackdrop = document.getElementById('modalBackdrop');

    // Инициализация Select2
    openFiltersButton.addEventListener('click', function() {
        modalBackdrop.style.display = 'block';
        filtersDiv.style.display = 'block';
        $(filtersDiv).find('.select2').select2({
            width: '100%',
            dropdownParent: $(filtersDiv)
        });
    });

    closeFiltersButton.addEventListener('click', function() {
        modalBackdrop.style.display = 'none';
        filtersDiv.style.display = 'none';
        $(filtersDiv).find('.select2').select2('destroy');
    });

    // Инициализация DataTables
    $('#requestsTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Russian.json" // Подключение русского языка
        }
    });
});

document.getElementById('exportPdf').addEventListener('click', function() {
    window.location.href = '{% url "export_pdf" %}';
});

document.querySelectorAll('.delete-btn').forEach(function(button) {
    button.addEventListener('click', function(event) {
        if (!confirm('Вы уверены, что хотите удалить эту заявку?')) {
            event.preventDefault();
        }
    });
});

// Select all checkboxes
document.getElementById('select-all').addEventListener('click', function(event) {
    var isChecked = event.target.checked;
    document.querySelectorAll('input[name="selected_requests"]').forEach(function(checkbox) {
        checkbox.checked = isChecked;
    });
});
</script>

<style>
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 10;
}

.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: white;
  padding: 20px;
  z-index: 11;
  display: none;
  max-width: 90%; /* Максимальная ширина */
  max-height: 90%; /* Максимальная высота */
  overflow-y: auto; /* Добавление прокрутки при необходимости */
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
}

/* Медиа-запросы для мобильных устройств */
@media (max-width: 600px) {
  .modal {
    width: 100%;
    height: 100%;
    max-width: 100%;
    max-height: 100%;
    overflow-y: auto;
  }
}
</style>
{% endblock %}
