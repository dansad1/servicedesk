{% extends "base.html" %}
{% load static %}

{% block extrahead %}
  <!-- Include CKEditor JS files and form media -->
  <script type="text/javascript" src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
  <script type="text/javascript" src="{% static 'ckeditor/ckeditor/ckeditor.js' %}"></script>
  {{ form.media }}
  {{ comment_form.media }}
{% endblock %}

{% block content %}
<h1>Request Detail and Update</h1>

<!-- Request Update Form -->
{% if can_edit %}
    <form method="post" action="{% url 'request_detail_update' pk=request_instance.pk %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" name="submit_update">Update Request</button>
    </form>
{% else %}
    <!-- Request Detail View for users without edit permission -->
    <p>Title: {{ request_instance.title }}</p>
    <p>Description: {{ request_instance.description|safe }}</p>
    <p>Status: {{ request_instance.status }}</p>
    <!-- Other fields can be shown here if necessary -->
{% endif %}

<!-- Attachments Section -->
<h3>Attachments</h3>
{% if request_instance.attachment %}
    <p><a href="{{ request_instance.attachment.url }}">{{ request_instance.attachment.name }}</a></p>
{% else %}
    <p>No attachments available.</p>
{% endif %}

<!-- Comments Section -->
<h2>Comments</h2>
<div class="comments">
    {% for comment in comments %}
        <div class="comment">
            <p><strong>{{ comment.author.username }}</strong> <em>{{ comment.created_at|date:"N d, Y H:i" }}</em></p>
            <p>{{ comment.text|safe }}</p>
            <!-- Display the attached file if it exists for the comment -->
            {% if comment.attachment %}
                <p>Attachment: <a href="{{ comment.attachment.url }}">{{ comment.attachment.name }}</a></p>
            {% endif %}
        </div>
    {% empty %}
        <p>No comments yet.</p>
    {% endfor %}
</div>

<!-- Add Comment Form -->
{% if can_edit %}
    <h3>Add a Comment</h3>
    <form method="post" action="{% url 'request_detail_update' pk=request_instance.pk %}" enctype="multipart/form-data">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit" name="submit_comment">Add Comment</button>
    </form>
{% endif %}
{% endblock %}
