{% extends "base.html" %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2/dist/js/select2.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js"></script>

<div class="notifications-list">
    <h3 class="text-center text-4xl p-10 max-w-4xl m-auto">Настройки уведомлений</h3>
    <table id="summaryTable" class="table">
        <thead>
            <tr>
                <th>Роль</th>
                {% for event_key, event_name in events %}
                <th>{{ event_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for group, event_settings in settings_list %}
            <tr>
                <td>
                    <button type="button" class="btn btn-link" data-toggle="modal" data-target="#modal-{{ group.id }}">
                        {{ group.name }}
                    </button>
                </td>
                {% for event in event_settings %}
                <td>{{ event.has_template }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for group, event_settings in settings_list %}
<div class="modal fade" id="modal-{{ group.id }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel-{{ group.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel-{{ group.id }}">Редактировать уведомления для роли: {{ group.name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'notification_detail' group_id=group.id %}">
                    {% csrf_token %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Событие</th>
                                <th>Шаблон уведомлений</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event_key, event_name in events %}
                            <tr>
                                <td>{{ event_name }}</td>
                                <td>
                                    {% for form_event_key, form in forms.items %}
                                        {% if form_event_key == event_key %}
                                            {{ form.template }}
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    $('.select2').select2({
        width: '100%'
    });

    // Инициализация DataTables
    $('#summaryTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Russian.json"
        }
    });
});
</script>

{% endblock %}
